/*
 ============================================================================
 Name        : PRESENT.c
 Author      : 
 Version     :
 Copyright   : Your copyright notice
 Description : Hello World in C, Ansi-style
 ============================================================================
 */


#include "func.h"

u8 text[SIZE_TEXT];
u8 key[SIZE_KEY];
u8 sub_key[NUM_ROUND][SIZE_SUB_KEY];
u8 sub_key_complete[NUM_ROUND][SIZE_SUB_KEY/8];

/*
@TEST VECTOR
			           128-bit Key	  64-bit Plaintext	64-bit Ciphertext
0x00000000000000000000000000000000 	0x0000000000000000 0x96db702a2e6900af
0xffffffffffffffffffffffffffffffff 	0x0000000000000000 0x13238c710272a5d8	<< current version
0x00000000000000000000000000000000  0xffffffffffffffff 0x3c6019e5e5edd563
0xffffffffffffffffffffffffffffffff  0xffffffffffffffff 0x628d9fbd4218e5b4
*/

//#define S_BOX_VALUE_GEN
//#define BIT_CTR_32


#ifndef BIT_CTR_32
//u8 in_text	[SIZE_TEXT / 8] 	= { 0, };
u8 in_text	[SIZE_TEXT / 8] 	= { 0, 0, 0x12, 0x34, 0x56, 0x78, 0x9A, 0xBC};	//16-bit counter mode test-vector
#else
u8 in_text	[SIZE_TEXT / 8] 	= { 0, 0, 0, 0, 0x12, 0x34, 0x56, 0x78};	//32-bit counter mode test-vector
#endif
u8 in_key	[SIZE_KEY / 8] 		= { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff };

u8 ROL_u8(u8 x, u8 n) {	return ((u8) ((x) << (n)) | (u8) ((x) >> (8 - (n)))); }
u8 ROR_u8(u8 x, u8 n) {	return ((u8) ((x) >> (n)) | (u8) ((x) << (8 - (n)))); }

// previous
//u16 ROL_u16(u16 x, u16 n) {	return ((u16) ((x) << (n)) | (u16) ((x) >> (16 - (n)))); }
//u16 ROR_u16(u16 x, u16 n) { return ((u16) ((x) >> (n)) | (u16) ((x) << (16 - (n)))); }

// updated
u16 ROL_u16(u16 x, u16 n) {	return ((u16) ((x) << (n)) ); }
u16 ROR_u16(u16 x, u16 n) { return ((u16) ((x) >> (n)) ); }

//16-bit
//ver1
u16 LUT0[]={0x798D, 0x799C, 0x788C, 0x789D, 0x699D, 0x688C, 0x688D, 0x798C, 0x689C, 0x698D, 0x799D, 0x699C, 0x698C, 0x788D, 0x789C, 0x689D, };
u16 LUT1[]={0x3B29, 0x3B38, 0x3A28, 0x3A39, 0x2B39, 0x2A28, 0x2A29, 0x3B28, 0x2A38, 0x2B29, 0x3B39, 0x2B38, 0x2B28, 0x3A29, 0x3A38, 0x2A39, };
u16 LUT2[]={0xDB63, 0xDB72, 0xDA62, 0xDA73, 0xCB73, 0xCA62, 0xCA63, 0xDB62, 0xCA72, 0xCB63, 0xDB73, 0xCB72, 0xCB62, 0xDA63, 0xDA72, 0xCA73, };
u16 LUT3[]={0xBDA3, 0xBDB2, 0xBCA2, 0xBCB3, 0xADB3, 0xACA2, 0xACA3, 0xBDA2, 0xACB2, 0xADA3, 0xBDB3, 0xADB2, 0xADA2, 0xBCA3, 0xBCB2, 0xACB3, };

//32-bit
//ver1
u16 LUT0_32[]={
		0xB30B, 0xB31A, 0xB20A, 0xB21B, 0xA31B, 0xA20A, 0xA20B, 0xB30A, 0xA21A, 0xA30B, 0xB31B, 0xA31A, 0xA30A, 0xB20B, 0xB21A, 0xA21B, 0xB329, 0xB338, 0xB228, 0xB239, 0xA339, 0xA228, 0xA229, 0xB328, 0xA238, 0xA329, 0xB339, 0xA338, 0xA328, 0xB229, 0xB238, 0xA239, 0xB109, 0xB118, 0xB008, 0xB019, 0xA119, 0xA008, 0xA009, 0xB108, 0xA018, 0xA109, 0xB119, 0xA118, 0xA108, 0xB009, 0xB018, 0xA019, 0xB12B, 0xB13A, 0xB02A, 0xB03B, 0xA13B, 0xA02A, 0xA02B, 0xB12A, 0xA03A, 0xA12B, 0xB13B, 0xA13A, 0xA12A, 0xB02B, 0xB03A, 0xA03B,
		0x932B, 0x933A, 0x922A, 0x923B, 0x833B, 0x822A, 0x822B, 0x932A, 0x823A, 0x832B, 0x933B, 0x833A, 0x832A, 0x922B, 0x923A, 0x823B, 0x9109, 0x9118, 0x9008, 0x9019, 0x8119, 0x8008, 0x8009, 0x9108, 0x8018, 0x8109, 0x9119, 0x8118, 0x8108, 0x9009, 0x9018, 0x8019, 0x910B, 0x911A, 0x900A, 0x901B, 0x811B, 0x800A, 0x800B, 0x910A, 0x801A, 0x810B, 0x911B, 0x811A, 0x810A, 0x900B, 0x901A, 0x801B, 0xB309, 0xB318, 0xB208, 0xB219, 0xA319, 0xA208, 0xA209, 0xB308, 0xA218, 0xA309, 0xB319, 0xA318, 0xA308, 0xB209, 0xB218, 0xA219,
		0x9129, 0x9138, 0x9028, 0x9039, 0x8139, 0x8028, 0x8029, 0x9128, 0x8038, 0x8129, 0x9139, 0x8138, 0x8128, 0x9029, 0x9038, 0x8039, 0x930B, 0x931A, 0x920A, 0x921B, 0x831B, 0x820A, 0x820B, 0x930A, 0x821A, 0x830B, 0x931B, 0x831A, 0x830A, 0x920B, 0x921A, 0x821B, 0xB32B, 0xB33A, 0xB22A, 0xB23B, 0xA33B, 0xA22A, 0xA22B, 0xB32A, 0xA23A, 0xA32B, 0xB33B, 0xA33A, 0xA32A, 0xB22B, 0xB23A, 0xA23B, 0x9329, 0x9338, 0x9228, 0x9239, 0x8339, 0x8228, 0x8229, 0x9328, 0x8238, 0x8329, 0x9339, 0x8338, 0x8328, 0x9229, 0x9238, 0x8239,
		0x9309, 0x9318, 0x9208, 0x9219, 0x8319, 0x8208, 0x8209, 0x9308, 0x8218, 0x8309, 0x9319, 0x8318, 0x8308, 0x9209, 0x9218, 0x8219, 0xB10B, 0xB11A, 0xB00A, 0xB01B, 0xA11B, 0xA00A, 0xA00B, 0xB10A, 0xA01A, 0xA10B, 0xB11B, 0xA11A, 0xA10A, 0xB00B, 0xB01A, 0xA01B, 0xB129, 0xB138, 0xB028, 0xB039, 0xA139, 0xA028, 0xA029, 0xB128, 0xA038, 0xA129, 0xB139, 0xA138, 0xA128, 0xB029, 0xB038, 0xA039, 0x912B, 0x913A, 0x902A, 0x903B, 0x813B, 0x802A, 0x802B, 0x912A, 0x803A, 0x812B, 0x913B, 0x813A, 0x812A, 0x902B, 0x903A, 0x803B
};
u16 LUT1_32[]={
		0x7743, 0x7752, 0x7642, 0x7653, 0x6753, 0x6642, 0x6643, 0x7742, 0x6652, 0x6743, 0x7753, 0x6752, 0x6742, 0x7643, 0x7652, 0x6653, 0x7761, 0x7770, 0x7660, 0x7671, 0x6771, 0x6660, 0x6661, 0x7760, 0x6670, 0x6761, 0x7771, 0x6770, 0x6760, 0x7661, 0x7670, 0x6671, 0x7541, 0x7550, 0x7440, 0x7451, 0x6551, 0x6440, 0x6441, 0x7540, 0x6450, 0x6541, 0x7551, 0x6550, 0x6540, 0x7441, 0x7450, 0x6451, 0x7563, 0x7572, 0x7462, 0x7473, 0x6573, 0x6462, 0x6463, 0x7562, 0x6472, 0x6563, 0x7573, 0x6572, 0x6562, 0x7463, 0x7472, 0x6473,
		0x5763, 0x5772, 0x5662, 0x5673, 0x4773, 0x4662, 0x4663, 0x5762, 0x4672, 0x4763, 0x5773, 0x4772, 0x4762, 0x5663, 0x5672, 0x4673, 0x5541, 0x5550, 0x5440, 0x5451, 0x4551, 0x4440, 0x4441, 0x5540, 0x4450, 0x4541, 0x5551, 0x4550, 0x4540, 0x5441, 0x5450, 0x4451, 0x5543, 0x5552, 0x5442, 0x5453, 0x4553, 0x4442, 0x4443, 0x5542, 0x4452, 0x4543, 0x5553, 0x4552, 0x4542, 0x5443, 0x5452, 0x4453, 0x7741, 0x7750, 0x7640, 0x7651, 0x6751, 0x6640, 0x6641, 0x7740, 0x6650, 0x6741, 0x7751, 0x6750, 0x6740, 0x7641, 0x7650, 0x6651,
		0x5561, 0x5570, 0x5460, 0x5471, 0x4571, 0x4460, 0x4461, 0x5560, 0x4470, 0x4561, 0x5571, 0x4570, 0x4560, 0x5461, 0x5470, 0x4471, 0x5743, 0x5752, 0x5642, 0x5653, 0x4753, 0x4642, 0x4643, 0x5742, 0x4652, 0x4743, 0x5753, 0x4752, 0x4742, 0x5643, 0x5652, 0x4653, 0x7763, 0x7772, 0x7662, 0x7673, 0x6773, 0x6662, 0x6663, 0x7762, 0x6672, 0x6763, 0x7773, 0x6772, 0x6762, 0x7663, 0x7672, 0x6673, 0x5761, 0x5770, 0x5660, 0x5671, 0x4771, 0x4660, 0x4661, 0x5760, 0x4670, 0x4761, 0x5771, 0x4770, 0x4760, 0x5661, 0x5670, 0x4671,
		0x5741, 0x5750, 0x5640, 0x5651, 0x4751, 0x4640, 0x4641, 0x5740, 0x4650, 0x4741, 0x5751, 0x4750, 0x4740, 0x5641, 0x5650, 0x4651, 0x7543, 0x7552, 0x7442, 0x7453, 0x6553, 0x6442, 0x6443, 0x7542, 0x6452, 0x6543, 0x7553, 0x6552, 0x6542, 0x7443, 0x7452, 0x6453, 0x7561, 0x7570, 0x7460, 0x7471, 0x6571, 0x6460, 0x6461, 0x7560, 0x6470, 0x6561, 0x7571, 0x6570, 0x6560, 0x7461, 0x7470, 0x6471, 0x5563, 0x5572, 0x5462, 0x5473, 0x4573, 0x4462, 0x4463, 0x5562, 0x4472, 0x4563, 0x5573, 0x4572, 0x4562, 0x5463, 0x5472, 0x4473
};
u16 LUT2_32[]={
		0xF7C7, 0xF7D6, 0xF6C6, 0xF6D7, 0xE7D7, 0xE6C6, 0xE6C7, 0xF7C6, 0xE6D6, 0xE7C7, 0xF7D7, 0xE7D6, 0xE7C6, 0xF6C7, 0xF6D6, 0xE6D7, 0xF7E5, 0xF7F4, 0xF6E4, 0xF6F5, 0xE7F5, 0xE6E4, 0xE6E5, 0xF7E4, 0xE6F4, 0xE7E5, 0xF7F5, 0xE7F4, 0xE7E4, 0xF6E5, 0xF6F4, 0xE6F5, 0xF5C5, 0xF5D4, 0xF4C4, 0xF4D5, 0xE5D5, 0xE4C4, 0xE4C5, 0xF5C4, 0xE4D4, 0xE5C5, 0xF5D5, 0xE5D4, 0xE5C4, 0xF4C5, 0xF4D4, 0xE4D5, 0xF5E7, 0xF5F6, 0xF4E6, 0xF4F7, 0xE5F7, 0xE4E6, 0xE4E7, 0xF5E6, 0xE4F6, 0xE5E7, 0xF5F7, 0xE5F6, 0xE5E6, 0xF4E7, 0xF4F6, 0xE4F7,
		0xD7E7, 0xD7F6, 0xD6E6, 0xD6F7, 0xC7F7, 0xC6E6, 0xC6E7, 0xD7E6, 0xC6F6, 0xC7E7, 0xD7F7, 0xC7F6, 0xC7E6, 0xD6E7, 0xD6F6, 0xC6F7, 0xD5C5, 0xD5D4, 0xD4C4, 0xD4D5, 0xC5D5, 0xC4C4, 0xC4C5, 0xD5C4, 0xC4D4, 0xC5C5, 0xD5D5, 0xC5D4, 0xC5C4, 0xD4C5, 0xD4D4, 0xC4D5, 0xD5C7, 0xD5D6, 0xD4C6, 0xD4D7, 0xC5D7, 0xC4C6, 0xC4C7, 0xD5C6, 0xC4D6, 0xC5C7, 0xD5D7, 0xC5D6, 0xC5C6, 0xD4C7, 0xD4D6, 0xC4D7, 0xF7C5, 0xF7D4, 0xF6C4, 0xF6D5, 0xE7D5, 0xE6C4, 0xE6C5, 0xF7C4, 0xE6D4, 0xE7C5, 0xF7D5, 0xE7D4, 0xE7C4, 0xF6C5, 0xF6D4, 0xE6D5,
		0xD5E5, 0xD5F4, 0xD4E4, 0xD4F5, 0xC5F5, 0xC4E4, 0xC4E5, 0xD5E4, 0xC4F4, 0xC5E5, 0xD5F5, 0xC5F4, 0xC5E4, 0xD4E5, 0xD4F4, 0xC4F5, 0xD7C7, 0xD7D6, 0xD6C6, 0xD6D7, 0xC7D7, 0xC6C6, 0xC6C7, 0xD7C6, 0xC6D6, 0xC7C7, 0xD7D7, 0xC7D6, 0xC7C6, 0xD6C7, 0xD6D6, 0xC6D7, 0xF7E7, 0xF7F6, 0xF6E6, 0xF6F7, 0xE7F7, 0xE6E6, 0xE6E7, 0xF7E6, 0xE6F6, 0xE7E7, 0xF7F7, 0xE7F6, 0xE7E6, 0xF6E7, 0xF6F6, 0xE6F7, 0xD7E5, 0xD7F4, 0xD6E4, 0xD6F5, 0xC7F5, 0xC6E4, 0xC6E5, 0xD7E4, 0xC6F4, 0xC7E5, 0xD7F5, 0xC7F4, 0xC7E4, 0xD6E5, 0xD6F4, 0xC6F5,
		0xD7C5, 0xD7D4, 0xD6C4, 0xD6D5, 0xC7D5, 0xC6C4, 0xC6C5, 0xD7C4, 0xC6D4, 0xC7C5, 0xD7D5, 0xC7D4, 0xC7C4, 0xD6C5, 0xD6D4, 0xC6D5, 0xF5C7, 0xF5D6, 0xF4C6, 0xF4D7, 0xE5D7, 0xE4C6, 0xE4C7, 0xF5C6, 0xE4D6, 0xE5C7, 0xF5D7, 0xE5D6, 0xE5C6, 0xF4C7, 0xF4D6, 0xE4D7, 0xF5E5, 0xF5F4, 0xF4E4, 0xF4F5, 0xE5F5, 0xE4E4, 0xE4E5, 0xF5E4, 0xE4F4, 0xE5E5, 0xF5F5, 0xE5F4, 0xE5E4, 0xF4E5, 0xF4F4, 0xE4F5, 0xD5E7, 0xD5F6, 0xD4E6, 0xD4F7, 0xC5F7, 0xC4E6, 0xC4E7, 0xD5E6, 0xC4F6, 0xC5E7, 0xD5F7, 0xC5F6, 0xC5E6, 0xD4E7, 0xD4F6, 0xC4F7
};
u16 LUT3_32[]={
		0x3B47, 0x3B56, 0x3A46, 0x3A57, 0x2B57, 0x2A46, 0x2A47, 0x3B46, 0x2A56, 0x2B47, 0x3B57, 0x2B56, 0x2B46, 0x3A47, 0x3A56, 0x2A57, 0x3B65, 0x3B74, 0x3A64, 0x3A75, 0x2B75, 0x2A64, 0x2A65, 0x3B64, 0x2A74, 0x2B65, 0x3B75, 0x2B74, 0x2B64, 0x3A65, 0x3A74, 0x2A75, 0x3945, 0x3954, 0x3844, 0x3855, 0x2955, 0x2844, 0x2845, 0x3944, 0x2854, 0x2945, 0x3955, 0x2954, 0x2944, 0x3845, 0x3854, 0x2855, 0x3967, 0x3976, 0x3866, 0x3877, 0x2977, 0x2866, 0x2867, 0x3966, 0x2876, 0x2967, 0x3977, 0x2976, 0x2966, 0x3867, 0x3876, 0x2877,
		0x1B67, 0x1B76, 0x1A66, 0x1A77, 0x0B77, 0x0A66, 0x0A67, 0x1B66, 0x0A76, 0x0B67, 0x1B77, 0x0B76, 0x0B66, 0x1A67, 0x1A76, 0x0A77, 0x1945, 0x1954, 0x1844, 0x1855, 0x0955, 0x0844, 0x0845, 0x1944, 0x0854, 0x0945, 0x1955, 0x0954, 0x0944, 0x1845, 0x1854, 0x0855, 0x1947, 0x1956, 0x1846, 0x1857, 0x0957, 0x0846, 0x0847, 0x1946, 0x0856, 0x0947, 0x1957, 0x0956, 0x0946, 0x1847, 0x1856, 0x0857, 0x3B45, 0x3B54, 0x3A44, 0x3A55, 0x2B55, 0x2A44, 0x2A45, 0x3B44, 0x2A54, 0x2B45, 0x3B55, 0x2B54, 0x2B44, 0x3A45, 0x3A54, 0x2A55,
		0x1965, 0x1974, 0x1864, 0x1875, 0x0975, 0x0864, 0x0865, 0x1964, 0x0874, 0x0965, 0x1975, 0x0974, 0x0964, 0x1865, 0x1874, 0x0875, 0x1B47, 0x1B56, 0x1A46, 0x1A57, 0x0B57, 0x0A46, 0x0A47, 0x1B46, 0x0A56, 0x0B47, 0x1B57, 0x0B56, 0x0B46, 0x1A47, 0x1A56, 0x0A57, 0x3B67, 0x3B76, 0x3A66, 0x3A77, 0x2B77, 0x2A66, 0x2A67, 0x3B66, 0x2A76, 0x2B67, 0x3B77, 0x2B76, 0x2B66, 0x3A67, 0x3A76, 0x2A77, 0x1B65, 0x1B74, 0x1A64, 0x1A75, 0x0B75, 0x0A64, 0x0A65, 0x1B64, 0x0A74, 0x0B65, 0x1B75, 0x0B74, 0x0B64, 0x1A65, 0x1A74, 0x0A75,
		0x1B45, 0x1B54, 0x1A44, 0x1A55, 0x0B55, 0x0A44, 0x0A45, 0x1B44, 0x0A54, 0x0B45, 0x1B55, 0x0B54, 0x0B44, 0x1A45, 0x1A54, 0x0A55, 0x3947, 0x3956, 0x3846, 0x3857, 0x2957, 0x2846, 0x2847, 0x3946, 0x2856, 0x2947, 0x3957, 0x2956, 0x2946, 0x3847, 0x3856, 0x2857, 0x3965, 0x3974, 0x3864, 0x3875, 0x2975, 0x2864, 0x2865, 0x3964, 0x2874, 0x2965, 0x3975, 0x2974, 0x2964, 0x3865, 0x3874, 0x2875, 0x1967, 0x1976, 0x1866, 0x1877, 0x0977, 0x0866, 0x0867, 0x1966, 0x0876, 0x0967, 0x1977, 0x0976, 0x0966, 0x1867, 0x1876, 0x0877
};


void SUB_KEY_FUNC(u8* key) {
	u32 i, j;
	u8 key_tmp[SIZE_KEY];

	for (i = 0; i < 64; i++) {
		sub_key[0][i] = key[64 + i];
	}
	//update
	for (i = 1; i < NUM_ROUND; i++) {
		for (j = 0; j < 128; j++) {
			key_tmp[j] = 0;
		}
		for (j = 0; j < 128; j++) {
			key_tmp[(j + 61) % 128] = key[j];
		}

		S_BOX_FUNC(&key_tmp[124], &key_tmp[125], &key_tmp[126], &key_tmp[127]);
		S_BOX_FUNC(&key_tmp[120], &key_tmp[121], &key_tmp[122], &key_tmp[123]);
		ROUND_COUNTER(&key_tmp[62], &key_tmp[63], &key_tmp[64], &key_tmp[65],
		&key_tmp[66], i);

		for (j = 0; j < 128; j++) {
			key[j] = key_tmp[j];
		}

		for (j = 0; j < 64; j++) {
			sub_key[i][j] = key[64 + j];
		}
	}
}

void ENC_FUNC_16(u8* text, u16 (*sub_key)[4]){
	u16* text16 = (u16*)text;
	u32 i, j;

	for (i = 0; i < 15; i++) {
		for (j = 0; j < 4; j++) {
			text16[j] ^= (u16)(sub_key[2*i][j]);
		}

		PERMUTATE_FUNC_ZERO_16(&text16[0], &text16[1], &text16[2], &text16[3]);
		S_BOX_FUNC_16(&text16[0], &text16[1], &text16[2], &text16[3]);
		PERMUTATE_FUNC_ONE_16(&text16[0], &text16[1], &text16[2], &text16[3]);

		for (j = 0; j < 4; j++) {
			text16[j] ^= (u16)(sub_key[2*i + 1][j]);
		}
		S_BOX_FUNC_16(&text16[0], &text16[1], &text16[2], &text16[3]);

	}

	for (j = 0; j < 4; j++) {
		text16[j] ^= (u16)(sub_key[30][j]);
	}

	//P = P0 * P1
	PERMUTATE_FUNC_ONE_16(&text16[0], &text16[1], &text16[2], &text16[3]);
	PERMUTATE_FUNC_ZERO_16(&text16[0], &text16[1], &text16[2], &text16[3]);

	S_BOX_FUNC_16(&text16[0], &text16[1], &text16[2], &text16[3]);

	for (j = 0; j < 4; j++) {
		text16[j] ^= (u16)(sub_key[31][j]);
	}
}


void ENC_FUNC_CTR_16_ver1(u8* text, u16 (*sub_key)[4]){
	u16* text16 = (u16*)text;
	u32 i, j;

	text16[3] = LUT3[ ( text16[0] & 0xF000)>>12];
	text16[2] = LUT2[ ( text16[0] & 0x0F00)>>8];
	text16[1] = LUT1[ ( text16[0] & 0x00F0)>>4];
	text16[0] = LUT0[ ( text16[0] & 0x000F)];


	S_BOX_FUNC_16(&text16[0], &text16[1], &text16[2], &text16[3]);

	for (i = 1; i < 15; i++) {
		for (j = 0; j < 4; j++) {
			text16[j] ^= (u16) (sub_key[2 * i][j]);
		}

		PERMUTATE_FUNC_ZERO_16(&text16[0], &text16[1], &text16[2], &text16[3]);
		S_BOX_FUNC_16(&text16[0], &text16[1], &text16[2], &text16[3]);
		PERMUTATE_FUNC_ONE_16(&text16[0], &text16[1], &text16[2], &text16[3]);

		for (j = 0; j < 4; j++) {
			text16[j] ^= (u16) (sub_key[2 * i + 1][j]);
		}
		S_BOX_FUNC_16(&text16[0], &text16[1], &text16[2], &text16[3]);

	}

	for (j = 0; j < 4; j++) {
		text16[j] ^= (u16) (sub_key[30][j]);
	}

	//P = P0 * P1
	PERMUTATE_FUNC_ONE_16(&text16[0], &text16[1], &text16[2], &text16[3]);
	PERMUTATE_FUNC_ZERO_16(&text16[0], &text16[1], &text16[2], &text16[3]);

	S_BOX_FUNC_16(&text16[0], &text16[1], &text16[2], &text16[3]);

	for (j = 0; j < 4; j++) {
		text16[j] ^= (u16) (sub_key[31][j]);
	}
}

void ENC_FUNC_CTR_32_ver1(u8* text, u16 (*sub_key)[4]){
	u16* text16 = (u16*)text;
	u16 tmp;
	u32 i, j;


	text16[3] = LUT3_32[ ((text16[0] & 0xF000)>>12) + ((text16[1] & 0xF000)>>8)];
	text16[2] = LUT2_32[ ((text16[0] & 0x0F00)>>8) + ((text16[1] & 0x0F00)>>4)];
	tmp		  = LUT1_32[ ((text16[0] & 0x00F0)>>4) + (text16[1] & 0x00F0)];
	text16[0] = LUT0_32[ (text16[0] & 0x000F) + ((text16[1] & 0x000F)<<4)];
	text16[1] = tmp;


	S_BOX_FUNC_16(&text16[0], &text16[1], &text16[2], &text16[3]);

	for (i = 1; i < 15; i++) {
		for (j = 0; j < 4; j++) {
			text16[j] ^= (u16) (sub_key[2 * i][j]);
		}

		PERMUTATE_FUNC_ZERO_16(&text16[0], &text16[1], &text16[2], &text16[3]);
		S_BOX_FUNC_16(&text16[0], &text16[1], &text16[2], &text16[3]);
		PERMUTATE_FUNC_ONE_16(&text16[0], &text16[1], &text16[2], &text16[3]);

		for (j = 0; j < 4; j++) {
			text16[j] ^= (u16) (sub_key[2 * i + 1][j]);
		}
		S_BOX_FUNC_16(&text16[0], &text16[1], &text16[2], &text16[3]);

	}

	for (j = 0; j < 4; j++) {
		text16[j] ^= (u16) (sub_key[30][j]);
	}

	//P = P0 * P1
	PERMUTATE_FUNC_ONE_16(&text16[0], &text16[1], &text16[2], &text16[3]);
	PERMUTATE_FUNC_ZERO_16(&text16[0], &text16[1], &text16[2], &text16[3]);

	S_BOX_FUNC_16(&text16[0], &text16[1], &text16[2], &text16[3]);

	for (j = 0; j < 4; j++) {
		text16[j] ^= (u16) (sub_key[31][j]);
	}
}

void ENC_FUNC_CTR_GEN_16_ver1(u8* text, u16 (*sub_key)[4]){
	u16* text16 = (u16*)text;
	u32 j;

	for (j = 0; j < 4; j++) {
		text16[j] ^= (u16) (sub_key[0][j]);
	}

	PERMUTATE_FUNC_ZERO_16(&text16[0], &text16[1], &text16[2], &text16[3]);
	S_BOX_FUNC_16(&text16[0], &text16[1], &text16[2], &text16[3]);
	PERMUTATE_FUNC_ONE_16(&text16[0], &text16[1], &text16[2], &text16[3]);

	for (j = 0; j < 4; j++) {
		text16[j] ^= (u16) (sub_key[1][j]);
	}
}

void DEC_FUNC_16(u8* text, u16 (*sub_key)[4]){
	u16* text16 = (u16*)text;
	int i, j;

	for (j = 0; j < 4; j++) {
		text16[j] ^= (u16) (sub_key[31][j]);
	}

	S_BOX_INV_FUNC_16(&text16[0], &text16[1], &text16[2], &text16[3]);

	PERMUTATE_FUNC_ZERO_16(&text16[0], &text16[1], &text16[2], &text16[3]);
	PERMUTATE_FUNC_ONE_16(&text16[0], &text16[1], &text16[2], &text16[3]);

	for (j = 0; j < 4; j++) {
		text16[j] ^= (u16)(sub_key[30][j]);
	}

	for(i=14; i>-1; i--){
		S_BOX_INV_FUNC_16(&text16[0], &text16[1], &text16[2], &text16[3]);
		for (j = 0; j < 4; j++) {
			text16[j] ^= (u16) (sub_key[2 * i + 1][j]);
		}

		PERMUTATE_FUNC_ONE_16(&text16[0], &text16[1], &text16[2], &text16[3]);
		S_BOX_INV_FUNC_16(&text16[0], &text16[1], &text16[2], &text16[3]);
		PERMUTATE_FUNC_ZERO_16(&text16[0], &text16[1], &text16[2], &text16[3]);

		for (j = 0; j < 4; j++) {
			text16[j] ^= (u16) (sub_key[2 * i][j]);
		}
	}

}

void SUB_KEY_PERM(u16 (*sub_key)[4]){
	int i;
	for(i=0;i<31;i++){
		if(i%2==1){
			PERMUTATE_FUNC_ONE_16(&sub_key[i][0], &sub_key[i][1], &sub_key[i][2], &sub_key[i][3]);
			PERMUTATE_FUNC_ZERO_16(&sub_key[i][0], &sub_key[i][1], &sub_key[i][2], &sub_key[i][3]);
		}
	}
}




int main(void)
{
    int i;
    byte_to_bit(in_key, key, SIZE_KEY);

    SUB_KEY_FUNC(key);

    for(i=0;i<NUM_ROUND;i++){
	    bit_to_byte(sub_key[i], sub_key_complete[i], SIZE_TEXT);
    }

	u16 (*new16)[4] = (u16 (*)[4])sub_key_complete;
	SUB_KEY_PERM(new16);			// this is for key generation of "PRESENT RUNS FAST"

	u16* text16 = (u16*) in_text;	//type-casting 8-bit to 16-bit

/*
	for(i=0;i<256;i++){
		printf("0x%02X, ", LUT3_32[i]&0x00ff);
	}printf("\n\n");
	for(i=0;i<256;i++){
		printf("0x%02X, ", (LUT3_32[i]>>8)&0x00ff);
	}printf("\n\n");
*/

#ifdef S_BOX_VALUE_GEN
	u16 text16_tmp[4];

	u16 loop;
	u16 offset;
	u16 max_loop;

	text16_tmp[0] = text16[0];
	text16_tmp[1] = text16[1];
	text16_tmp[2] = text16[2];
	text16_tmp[3] = text16[3];

	loop = 0;
	offset = 3;
#ifndef BIT_CTR_32
	max_loop = 16;
#else
	max_loop = 256;
#endif

	for (i = 0; i < max_loop; i++) {
		text16[0] = text16_tmp[0];
		text16[1] = text16_tmp[1];
		text16[2] = text16_tmp[2];
		text16[3] = text16_tmp[3];

#ifndef BIT_CTR_32
		ENC_FUNC_CTR_GEN_16_ver1(in_text, new16);

		//test1
		printf("0x%04X, ", text16[0]);
		text16_tmp[0] += 1;

		//test2
		printf("0x%04X, ", text16[1]);
		text16_tmp[0] += 16;

		//test3
		printf("0x%04X, ", text16[2]);
		text16_tmp[0] += 256;

		//test4
		printf("0x%04X, ", text16[3]);
		text16_tmp[0] += 4096;
#else
		ENC_FUNC_CTR_GEN_16_ver1(in_text, new16);

		//printf("0x%04X 0x%04X 0x%04X 0x%04X\n",text16[0], text16[1], text16[2], text16[3]);

		if((loop)%64 == 0){
			printf("\n");
		}
		printf("0x%04X, ", text16[offset]);

		loop++;
		//text16_tmp[0] = (loop%4);
		text16_tmp[0] = (loop & 0x0F) << (offset * 4);
		text16_tmp[1] = ((loop >> 4) & 0x0F) << (offset * 4);
#endif
	}
#else
	printf("\nPlaintext: \n");
	printf("%04X %04X %04X %04X\n", text16[0], text16[1], text16[2], text16[3]);

	//ENC_FUNC_16(in_text, new16);				//encryption + ECB mode
#ifndef BIT_CTR_32
	ENC_FUNC_CTR_16_ver1(in_text, new16);		//encryption + CTR mode (add-round #2, S_BOX #1, P_ZERO #1, P_ONE #1)
#else
	ENC_FUNC_CTR_32_ver1(in_text, new16);		//encryption + CTR mode (add-round #2, S_BOX #1, P_ZERO #1, P_ONE #1)
#endif

	printf("\nCiphertext: \n");
	printf("%04X %04X %04X %04X\n", text16[0], text16[1], text16[2], text16[3]);

	DEC_FUNC_16(in_text, new16);

	printf("\nPlaintext: \n");
	printf("%04X %04X %04X %04X\n", text16[0], text16[1], text16[2], text16[3]);
#endif


	//printf("output %04X", 0x90^0x03^0x7D^0xB5^0xCE^0x98^0xDE^0x07);
	//0XE4^0XBC^0X2E^0X31^0X22^0X77^0XE4^0XDD

}

